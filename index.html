<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>15 X 3 - 유빈</title>
    <style>
        :root {
            --bg-color: #f5f5f7;
            --bg-clear: #ffffff;
            --text-main: #2d3436;
            --point-blue: #3498db;
            --point-green: #2ecc71;
            --nm-out: 8px 8px 16px #e0e0e0, -8px -8px 16px #ffffff;
            --nm-in: inset 4px 4px 8px #e0e0e0, inset -4px -4px 8px #ffffff;
            --nm-btn: 4px 4px 10px #e0e0e0, -4px -4px 10px #ffffff;
            --nm-btn-hover: 6px 6px 15px #d1d1d1, -6px -6px 15px #ffffff;
        }

        body {
            background: var(--bg-color); color: var(--text-main);
            font-family: 'Pretendard', -apple-system, sans-serif; margin: 0; padding: 0;
            height: 100vh; width: 100vw; display: flex; flex-direction: column; align-items: center;
            overflow: hidden; user-select: none; transition: background 1.5s ease;
            /* 바디 전체 드래그를 해제하고 필요한 곳만 드래그하게 변경 */
            -webkit-app-region: no-drag; 
        }

        /* [추가] 창을 끌 수 있는 투명한 핸들 (상단 버튼 제외 영역) */
        .drag-handle {
            position: fixed;
            top: 0;
            left: 0;
            width: calc(100% - 110px); /* 오른쪽 버튼들 공간 비워두기 */
            height: 60px;
            z-index: 10000;
            -webkit-app-region: drag;
            pointer-events: none; /* 클릭은 아래 요소로 통과 */
        }

        .top-menu { 
            position: fixed; top: 20px; right: 25px; display: flex; gap: 12px; z-index: 10001; 
            -webkit-app-region: no-drag !important; 
        }
        .menu-btn { 
            width: 34px; height: 34px; border-radius: 50%; background: var(--bg-color); 
            box-shadow: var(--nm-btn); display: flex; align-items: center; justify-content: center; 
            cursor: pointer; color: #777; transition: 0.2s; border: none; outline: none;
            -webkit-app-region: no-drag !important;
        }
        .menu-btn:hover { transform: scale(1.1); color: var(--point-blue); box-shadow: var(--nm-btn-hover); }
        
        .header { 
            margin-top: 0; 
            padding-top: 55px; 
            width: 100%;
            text-align: center; 
            transition: opacity 0.3s; 
            cursor: grab; 
            -webkit-app-region: drag; /* 제목 부분은 드래그 가능 */
        }
        .header:active { cursor: grabbing; }
        .header.locked { pointer-events: none; cursor: default; -webkit-app-region: no-drag; }
        .header h1 { font-size: 26px; font-weight: 900; letter-spacing: -1px; margin: 0; color: #333; display: inline-block; -webkit-app-region: no-drag; }

        .circle-container { 
            position: relative; width: 280px; height: 280px; margin-top: 40px; 
            display: flex; align-items: center; justify-content: center; 
            -webkit-app-region: no-drag; 
        }
        .circle-container.hidden { display: none !important; opacity: 0; }
        
        .outer-ring { position: absolute; width: 100%; height: 100%; border-radius: 50%; background: var(--bg-color); box-shadow: var(--nm-out); }
        .circle-base { position: absolute; width: 90%; height: 90%; border-radius: 50%; background: var(--bg-color); box-shadow: var(--nm-in); overflow: hidden; }
        .color-layer { position: absolute; width: 100%; height: 100%; border-radius: 50%; z-index: 2; pointer-events: none; opacity: 0.7; }
        .divider-container { position: absolute; width: 90%; height: 90%; border-radius: 50%; z-index: 100; pointer-events: none; -webkit-mask-image: radial-gradient(circle 35px, transparent 100%, black 100%); }
        .divider { position: absolute; width: 1.5px; height: 50%; background: rgba(255,255,255,0.8); left: 50%; top: 0; transform-origin: bottom center; }
        
        .click-area { position: absolute; width: 100%; height: 100%; z-index: 30; cursor: pointer; -webkit-app-region: no-drag; }
        .click-area.c1 { transform: rotate(-60deg); clip-path: polygon(50% 50%, -20% -20%, 120% -20%, 50% 50%); }
        .click-area.c2 { transform: rotate(60deg); clip-path: polygon(50% 50%, -20% -20%, 120% -20%, 50% 50%); }
        .click-area.c3 { transform: rotate(180deg); clip-path: polygon(50% 50%, -20% -20%, 120% -20%, 50% 50%); }

        .slot-content { position: absolute; font-size: 13px; font-weight: 800; color: #bbb; pointer-events: none; text-align: center; z-index: 40; width: 80px; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .slot-content.t1 { top: 90px; left: 35px; transform-origin: center; }
        .slot-content.t2 { top: 90px; right: 35px; transform-origin: center; }
        .slot-content.t3 { bottom: 55px; left: 50%; transform: translateX(-50%); transform-origin: top center; }

        .click-area.c1:hover ~ .t1 { color: var(--point-blue); transform: scale(1.15); }
        .click-area.c2:hover ~ .t2 { color: var(--point-blue); transform: scale(1.15); }
        .click-area.c3:hover ~ .t3 { color: var(--point-blue); transform: translateX(-50%) scale(1.15); }

        .active-text { color: #ffffff !important; font-weight: 900; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        .center-btn { position: absolute; width: 70px; height: 70px; background: var(--bg-color); border-radius: 50%; z-index: 50; box-shadow: var(--nm-btn); display: flex; align-items: center; justify-content: center; transition: 0.3s; cursor: default; top: 50%; left: 50%; transform: translate(-50%, -50%); -webkit-app-region: no-drag; }
        .center-btn.ready { cursor: pointer; }
        .center-btn.ready:hover { background: #ffffff; box-shadow: var(--nm-btn-hover); transform: translate(-50%, -50%) scale(1.05); }

        .icon-thumb { width: 30px; height: 30px; fill: none; stroke: #888; stroke-width: 2.5; transition: 0.3s; }
        .dots-container { display: flex; gap: 4px; pointer-events: none; }
        .dot { width: 6px; height: 6px; background-color: #ccc; border-radius: 50%; animation: dot-blink 1.4s infinite both; }
        @keyframes dot-blink { 0%, 80%, 100% { opacity: 0.3; } 40% { opacity: 1; } }

        #config-mode { display: none; flex-direction: column; align-items: center; margin-top: 40px; -webkit-app-region: no-drag; }
        .knob-outer { position: relative; width: 220px; height: 220px; border-radius: 50%; background: var(--bg-color); box-shadow: var(--nm-out); display: flex; align-items: center; justify-content: center; cursor: grab; -webkit-app-region: no-drag; }
        .knob-inner { position: absolute; width: 140px; height: 140px; border-radius: 50%; background: var(--bg-color); box-shadow: var(--nm-btn); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; cursor: pointer; transition: 0.2s; -webkit-app-region: no-drag; }
        .knob-indicator { position: absolute; top: 15px; width: 4px; height: 15px; background: var(--point-blue); border-radius: 2px; transform-origin: 50% 95px; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: none; }
        .knob-ticks { position: absolute; width: 100%; height: 100%; border-radius: 50%; z-index: 5; }
        .tick-hitbox { position: absolute; width: 30px; height: 30px; left: 50%; top: 0; transform-origin: 15px 110px; cursor: pointer; display: flex; justify-content: center; align-items: flex-start; }
        .tick { width: 2px; height: 12px; background: #bbb; border-radius: 1px; margin-top: 5px; }
        .knob-value { font-size: 44px; font-weight: 900; color: #333; pointer-events: none; }
        .knob-label { font-size: 11px; font-weight: 800; color: #aaa; margin-top: 2px; pointer-events: none; }

        .timer-screen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 9000; background: var(--bg-color); -webkit-app-region: no-drag; }
        /* 타이머 화면에서도 위쪽은 드래그 가능하게 설정 */
        .timer-drag { position: absolute; top: 0; left: 0; width: 100%; height: 100px; -webkit-app-region: drag; z-index: 9005; }
        
        .noise-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: url('https://www.transparenttextures.com/patterns/p6-mini.png'); opacity: 0.3; z-index: 9001; pointer-events: none; mix-blend-mode: multiply; }
        .phase-indicator { position: absolute; bottom: 100px; font-size: 14px; font-weight: 800; color: #aaa; letter-spacing: 2px; z-index: 9100; display: flex; align-items: center; justify-content: center; height: 50px; -webkit-app-region: no-drag; }
        .focus-text-container { position: relative; z-index: 9100; cursor: pointer; text-align: center; height: 100px; display: flex; align-items: center; justify-content: center; margin-top: -80px; -webkit-app-region: no-drag; }
        .focus-task-text { font-size: 42px; font-weight: 900; color: #333; transition: filter 0.5s ease; filter: blur(8px); white-space: nowrap; }
        .skip-btn-wrap { width: 44px; height: 44px; border-radius: 50%; background: var(--bg-color); box-shadow: var(--nm-btn); display: flex; align-items: center; justify-content: center; cursor: pointer; color: #444; transition: 0.2s; -webkit-app-region: no-drag; }
        .skip-btn-wrap:hover { transform: scale(1.1); box-shadow: var(--nm-btn-hover); color: #000; }

        #boat-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: none; z-index: 9800; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; -webkit-app-region: drag; }
        .boat-icon { width: 65px; height: 65px; fill: #444; opacity: 0.7; animation: boat-float 3.5s ease-in-out infinite; }
        .wave-icon { width: 80px; margin-top: -15px; fill: #3498db; opacity: 0.4; animation: wave-move 2.5s ease-in-out infinite; }
        @keyframes boat-float { 0%, 100% { transform: translateY(0) rotate(-4deg); } 50% { transform: translateY(-12px) rotate(4deg); } }
        @keyframes wave-move { 0%, 100% { transform: translateX(-5px); } 50% { transform: translateX(5px); } }
        .ending-active { background: linear-gradient(135deg, #e0f2fe 0%, #f5f5f7 50%, #f0fdf4 100%) !important; }

        #edit-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 10000; -webkit-app-region: no-drag; }
        .modal-content { background: var(--bg-color); padding: 35px; border-radius: 28px; box-shadow: var(--nm-out); width: 240px; }
        .modal-input { width: 100%; background: transparent; border: none; border-bottom: 2px solid var(--point-blue); text-align: center; font-size: 18px; font-weight: 700; outline: none; color: #333; }
    </style>
</head>
<body onclick="initAudio()">
    <div class="drag-handle"></div>

    <div id="boat-container">
        <svg class="boat-icon" viewBox="0 0 24 24"><path d="M4 18h16l1-4H3l1 4zM12 2v12m0-12L5 9h7"/></svg>
        <svg class="wave-icon" viewBox="0 0 100 20"><path d="M0 10 Q25 0 50 10 T100 10 L100 20 L0 20 Z"/></svg>
    </div>

    <div class="top-menu">
        <div class="menu-btn" onclick="resetAndStopTimer()"><div style="width:8px;height:8px;background:#555;border-radius:1px;"></div></div>
        <div class="menu-btn" onclick="exitApp()">✕</div>
    </div>

    <div class="header" id="main-header" ondblclick="enterConfig()">
        <h1 id="header-title">15 X 3</h1>
    </div>

    <div class="circle-container" id="main-widget">
        <div class="outer-ring"></div>
        <div class="circle-base"><div class="color-layer" id="color-layer"></div></div>
        <div class="divider-container">
            <div class="divider" style="transform:rotate(0deg)"></div>
            <div class="divider" style="transform:rotate(120deg)"></div>
            <div class="divider" style="transform:rotate(240deg)"></div>
        </div>
        
        <div class="click-area c1" onclick="openEdit(0)"></div><div class="slot-content t1" id="txt-0">TASK 1</div>
        <div class="click-area c2" onclick="openEdit(1)"></div><div class="slot-content t2" id="txt-1">TASK 2</div>
        <div class="click-area c3" onclick="openEdit(2)"></div><div class="slot-content t3" id="txt-2">TASK 3</div>
        
        <div class="center-btn" id="main-btn-container" onclick="handleCenterClick()"></div>
    </div>

    <div id="config-mode">
        <div class="knob-outer" id="knob-area">
            <div class="knob-ticks" id="knob-ticks"></div>
            <div class="knob-indicator" id="knob-pointer"></div>
            <div class="knob-inner" onclick="nextConfigStep()">
                <div class="knob-value" id="knob-num">15</div>
                <div class="knob-label" id="knob-step-label">FOCUS MIN</div>
            </div>
        </div>
    </div>

    <div class="timer-screen" id="timer-screen">
        <div class="timer-drag"></div>
        <div class="phase-indicator" id="phase-indicator">1 / 3</div>
        <div class="noise-overlay" id="noise-overlay"></div>
        <div class="focus-text-container" id="focus-container" onclick="togglePause()" ondblclick="cheatNext()" onmouseenter="showTime(true)" onmouseleave="showTime(false)">
            <div class="focus-task-text" id="focus-task-display">READY</div>
        </div>
    </div>

    <div id="edit-modal">
        <div class="modal-content"><input type="text" id="modal-input" class="modal-input" onkeypress="handleEnter(event)"></div>
    </div>

    <script>
        localStorage.removeItem('15x3_tasks_only'); 
        
        let tasks = ["", "", ""];
        let focusTime = 15; let restTime = 3;
        let currentIdx = -1; let remainTime = 0;
        let myInterval = null; let isPaused = false; let isHoveringTime = false;
        let currentPhase = 0; let isConfiguring = false; let configStep = 0; let tempVal = 15;
        let currentRotation = 0; let isEnding = false;
        let endingTimer = null;

        let activeAudios = [];
        let audioContextInitialized = false;

        function initAudio() {
            if (audioContextInitialized) return;
            const audio = new Audio();
            audio.play().then(() => { audioContextInitialized = true; }).catch(() => {});
        }

        function playZepSound(fileName) {
            const audioUrl = `https://jeonyoobin.github.io/15X3/${fileName}.wav`;
            const audio = new Audio(audioUrl);
            activeAudios.push(audio);
            audio.play().catch(e => {});
            audio.onended = () => { activeAudios = activeAudios.filter(a => a !== audio); };
        }

        function killSound() {
            activeAudios.forEach(audio => { audio.pause(); audio.currentTime = 0; });
            activeAudios = [];
        }

        const arrowIcon = `<div class="skip-btn-wrap" onclick="nextPhase(event)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></div>`;

        window.onload = function() {
            const saved = localStorage.getItem('15x3_config');
            if (saved) {
                const parsed = JSON.parse(saved);
                focusTime = parsed.focusTime || 15;
                restTime = parsed.restTime || 3;
            }
            updateHeader(); 
            render();
        };

        function updateTicks() {
            const container = document.getElementById('knob-ticks'); container.innerHTML = "";
            for(let i=0; i<12; i++) {
                const box = document.createElement('div'); box.className = 'tick-hitbox';
                box.style.transform = `translateX(-15px) rotate(${i * 30}deg)`;
                const tick = document.createElement('div'); tick.className = 'tick';
                box.appendChild(tick);
                box.onclick = (e) => { e.stopPropagation(); let val = (i === 0) ? (configStep === 0 ? 60 : 12) : (configStep === 0 ? i * 5 : i); if (tempVal !== val) { tempVal = val; playZepSound('G'); updateKnobUI(true); } };
                container.appendChild(box);
            }
        }

        function updateHeader() { document.getElementById('header-title').innerText = `${focusTime} X ${restTime}`; }
        
        function render() {
            let count = 0;
            const container = document.getElementById('main-btn-container');
            const layer = document.getElementById('color-layer');
            tasks.forEach((task, i) => {
                const txt = document.getElementById(`txt-${i}`);
                if (task && task.trim() !== "") {
                    txt.innerText = "READY"; txt.classList.add('active-text'); count++;
                } else {
                    txt.innerText = `TASK ${i+1}`; txt.classList.remove('active-text');
                }
            });
            const s = tasks.map(t => t ? 'var(--point-blue)' : 'transparent');
            layer.style.background = `conic-gradient(from 0deg, ${s[1]} 0deg 120deg, ${s[2]} 120deg 240deg, ${s[0]} 240deg 360deg)`;
            if (count === 3) { container.innerHTML = `<svg class="icon-thumb" viewBox="0 0 24 24"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>`; container.classList.add('ready'); }
            else { container.innerHTML = count > 0 ? `<div class="dots-container"><div class="dot" style="animation-delay:0s"></div><div class="dot" style="animation-delay:0.2s"></div><div class="dot" style="animation-delay:0.4s"></div></div>` : ""; container.classList.remove('ready'); }
        }

        function enterConfig() {
            isConfiguring = true; configStep = 0; tempVal = focusTime; currentRotation = (focusTime/60)*360;
            document.getElementById('main-widget').classList.add('hidden');
            document.getElementById('config-mode').style.display = 'flex';
            document.getElementById('knob-pointer').style.background = "var(--point-blue)";
            document.getElementById('knob-step-label').innerText = "FOCUS MIN";
            updateTicks(); updateKnobUI(false);
        }

        function nextConfigStep() {
            if (configStep === 0) {
                focusTime = tempVal; configStep = 1; tempVal = restTime; currentRotation = (restTime/12)*360;
                document.getElementById('knob-step-label').innerText = "REST MIN";
                document.getElementById('knob-pointer').style.background = "var(--point-green)";
                updateTicks(); updateKnobUI(false);
            } else {
                restTime = tempVal; isConfiguring = false;
                document.getElementById('config-mode').style.display = 'none';
                document.getElementById('main-widget').classList.remove('hidden');
                updateHeader(); saveConfig();
            }
        }

        let isDragging = false;
        const knobArea = document.getElementById('knob-area');
        knobArea.onmousedown = () => isDragging = true;
        window.onmouseup = () => isDragging = false;
        window.onmousemove = (e) => { if (isDragging && isConfiguring) handleKnobMove(e.clientX, e.clientY); };

        knobArea.onwheel = (e) => {
            if (!isConfiguring) return;
            e.preventDefault();
            let step = configStep === 0 ? 5 : 1;
            let dir = e.deltaY < 0 ? step : -step;
            let newVal = tempVal + dir;
            if (newVal > (configStep===0?60:12)) newVal = (configStep===0?5:1);
            else if (newVal < (configStep===0?5:1)) newVal = (configStep===0?60:12);
            if (tempVal !== newVal) { tempVal = newVal; playZepSound('G'); updateKnobUI(true); }
        };

        function handleKnobMove(clientX, clientY) {
            const rect = knobArea.getBoundingClientRect();
            const angle = Math.atan2(clientY - (rect.top + rect.height / 2), clientX - (rect.left + rect.width / 2)) * 180 / Math.PI + 90;
            let normalizedAngle = (angle + 360) % 360;
            let newVal;
            if (configStep === 0) { newVal = Math.round((normalizedAngle / 360) * 12) * 5; if (newVal === 0) newVal = 60; }
            else { newVal = Math.round((normalizedAngle / 360) * 12); if (newVal === 0) newVal = 12; }
            if (tempVal !== newVal) { tempVal = newVal; playZepSound('G'); updateKnobUI(true); }
        }

        function updateKnobUI(useSmartRotate) {
            document.getElementById('knob-num').innerText = tempVal;
            const max = configStep === 0 ? 60 : 12;
            let targetAngle = (tempVal / max) * 360;
            if (useSmartRotate) { let diff = (targetAngle - (currentRotation % 360) + 540) % 360 - 180; currentRotation += diff; }
            else { currentRotation = targetAngle; }
            document.getElementById('knob-pointer').style.transform = `rotate(${currentRotation}deg)`;
        }

        function handleCenterClick() { if (tasks.filter(t => t.trim() !== "").length === 3) startTimer(); }
        
        function startTimer() {
            playZepSound('A'); currentPhase = 0; isEnding = false;
            const PHASES = [focusTime * 60, restTime * 60, focusTime * 60, restTime * 60, focusTime * 60];
            remainTime = PHASES[0]; isPaused = false;
            document.getElementById('main-widget').classList.add('hidden');
            document.getElementById('main-header').style.opacity = '0';
            document.getElementById('main-header').classList.add('locked');
            document.getElementById('timer-screen').style.display = 'flex';
            if (myInterval) clearInterval(myInterval);
            myInterval = setInterval(() => { if (!isPaused) { remainTime--; updateDisplay(PHASES); if (remainTime <= 0) nextPhase(null, PHASES); } }, 1000);
            updateDisplay(PHASES);
        }

        function updateDisplay(PHASES) {
            if (!PHASES) PHASES = [focusTime * 60, restTime * 60, focusTime * 60, restTime * 60, focusTime * 60];
            const display = document.getElementById('focus-task-display');
            const noise = document.getElementById('noise-overlay');
            const screen = document.getElementById('timer-screen');
            const indicator = document.getElementById('phase-indicator');
            const isRest = currentPhase % 2 !== 0;
            const total = PHASES[currentPhase];
            const progress = 1 - (remainTime / total);
            indicator.innerHTML = isRest ? arrowIcon : `${Math.floor(currentPhase/2) + 1} / 3`;
            if (isPaused || isHoveringTime) {
                const m = Math.floor(remainTime / 60); const s = remainTime % 60;
                display.innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            } else { display.innerText = isRest ? "REST" : tasks[Math.floor(currentPhase/2)]; }
            if (isPaused) { display.style.filter = "blur(8px)"; noise.style.opacity = "0.3"; }
            else {
                if (isRest) { display.style.filter = "blur(0px)"; noise.style.opacity = "0"; screen.style.background = "var(--bg-clear)"; }
                else { display.style.filter = `blur(${(1-progress)*8}px)`; noise.style.opacity = (1-progress)*0.4; screen.style.background = progress > 0.8 ? 'var(--bg-clear)' : 'var(--bg-color)'; }
            }
        }

        function cheatNext() { remainTime = 0; }
        function togglePause() { isPaused = !isPaused; playZepSound(isPaused ? 'B' : 'F'); updateDisplay(); }
        function showTime(val) { isHoveringTime = val; if(currentPhase < 5) updateDisplay(); }

        function nextPhase(e, PHASES) {
            if (e) e.stopPropagation();
            if (!PHASES) PHASES = [focusTime * 60, restTime * 60, focusTime * 60, restTime * 60, focusTime * 60];
            currentPhase++;
            if (currentPhase >= PHASES.length) { finishCelebration(); }
            else { remainTime = PHASES[currentPhase]; playZepSound(currentPhase % 2 !== 0 ? 'C' : 'D'); updateDisplay(PHASES); }
        }

        function finishCelebration() {
            if (isEnding) return;
            isEnding = true;
            playZepSound('E');
            document.getElementById('timer-screen').style.display = 'none';
            document.getElementById('main-header').style.opacity = '0';
            document.getElementById('main-header').classList.add('locked');
            document.getElementById('main-widget').classList.add('hidden');
            document.body.classList.add('ending-active');
            document.getElementById('boat-container').style.display = 'flex';
            if (endingTimer) clearTimeout(endingTimer);
            endingTimer = setTimeout(() => { resetAndStopTimer(); }, 23000);
        }

        function resetAndStopTimer() {
            killSound();
            if (endingTimer) clearTimeout(endingTimer);
            if (myInterval) clearInterval(myInterval);
            tasks = ["", "", ""]; 
            const widget = document.getElementById('main-widget');
            widget.classList.remove('hidden');
            document.getElementById('main-header').style.opacity = '1';
            document.getElementById('main-header').classList.remove('locked');
            document.getElementById('timer-screen').style.display = 'none';
            document.getElementById('boat-container').style.display = 'none';
            document.body.classList.remove('ending-active');
            isPaused = false; isEnding = false; 
            render();
        }

        function openEdit(idx) { currentIdx = idx; document.getElementById('modal-input').value = tasks[idx]; document.getElementById('edit-modal').style.display = 'flex'; setTimeout(()=>document.getElementById('modal-input').focus(),100); }
        function closeEdit() { tasks[currentIdx] = document.getElementById('modal-input').value; document.getElementById('edit-modal').style.display = 'none'; render(); }
        function handleEnter(e) { if (e.key === 'Enter') closeEdit(); }
        document.getElementById('edit-modal').onclick = function(e) { if(e.target === this) closeEdit(); };
        
        function saveConfig() {
            localStorage.setItem('15x3_config', JSON.stringify({ focusTime, restTime }));
        }
        
        function exitApp() {
            killSound();
            window.parent.postMessage({ type: 'close' }, '*');
            setTimeout(() => { window.close(); }, 100);
        }
    </script>
</body>
</html>
